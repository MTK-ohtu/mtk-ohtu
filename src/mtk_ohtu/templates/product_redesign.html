<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='dropdown.css') }}">
    <meta name="viewport" layout-content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="{{url_for('static', filename='images/favicon/favicon.ico') }}">


    <style>
        /* Base CSS for the grid containers */
        .grid-container {
            display: flex;
            height: calc(100vh - 100px);
            margin: auto;
            border-radius: 20px 0 0 0;
            border: var(--common-border);
            background-color: var(--focus-background-color);
            padding: 0.3% 0.3% 0% 0.1%;

        }

        .upper_left_container {
            /* position: relative; */
            min-height: 35%;
            height: 35%;
            max-height: 35%;
            max-width: 99%;
            width: 99%;
            overflow-y: hidden;
            overflow-x: hidden;
        }

        .contractor_list_container {
            height: 63%;
            width: 99%;
            max-width: 99%;
            flex:1;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
            background-color: var(--focus-background-color);
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .contractor_list_container::-webkit-scrollbar * {
            display: none;
        }

        .filter_container {
            background-color: #f8f8f8;
            flex: 0 1 auto;
        }

        .map_container {
            width: 100%;
            max-width: 100%;
        }
        
        .map_container button {
            background-repeat: no-repeat;
            background-color: var(--non-focus-background-color);
            align-self: center;
            border: var(--common-border);
            border-radius: 10px;
            margin-right: 5px;
            max-width: 45px;
            transition: translate var(--button-transition-time) ease-in-out;
        }

        .map_container button:hover {
            border: var(--focus-border);
        }

        .map_container button:active {
            transform: translate(3px, 3px);
            scale: 0.95;
        }
        
        .map_container button.pressed {
            filter: invert(100%);
        }


        .layout_header {
            width: 100%;
            /* Add your header styling here */
        }

        .top-buttons {
            z-index: 1000;
            position: relative;
            /*align rigth*/
            display: flex;
            justify-content: flex-end;

        }

        

        

        /* portait */
        @media (orientation: portrait) {
            .grid-container {
                height: 100vh;
                min-height: 100vh;
                max-height:100vh;
                flex-direction: column;
                width: 100%;
                min-width: 100%;
                max-width: 100%;
            }

            .left-container {
                flex: 3;
                /* overflow-y: auto; */
                width: 100%;
                min-height: 50%;
                height: 50%;
                max-height: 50%;
            }

            .right-container {
                flex: 3;
                min-height: 50%;
                height: 50%;
                max-height: 50%;
                width: 100%;
            }
            .map_container {
                min-height: 90%;
                max-height: 90%;
            }
            .toolbar {
                min-height: 10%;
                max-height: 10%
            }
        }

        @media (orientation: landscape) {

            
            @media screen and (max-width: 1000px) {
                .grid-container {
                    min-width: 100%;
                    max-width: 100%;
                    background-color: red;
                }
            }
            @media screen and (min-width: 1000px) {
                .grid-container {
                    min-width: 70%;
                    max-width: 70%;
                }
            }

            .grid-container {
                min-height: 100vh;
                max-height: 100vh;
                max-width: 1500px
            }
            
            .left-container {
                flex: 2;
                height: 99.5%;
                max-height: 100%;
                max-width: 40%;
            }
            .right-container {
                flex: 3;
                height: 100%;
                max-height: 100%;
                max-width: 60%;
                /* overflow: clip; */
                overflow: hidden;
            }
            .map_container {
                min-height: 94.5%;
                max-height: 94.5%;
            }
            .toolbar {
                min-height: 4%;
                max-height: 4%
            }
            
        }
    </style>
</head>

<body>
    <!-- Translatable texts -->
<p id="description" style="display:none">{{ _("description") }}</p>
<p id="services" style="display:none">{{ _("services") }}</p>
    <form action="{{ url_for('main.listing_bp.listing', listing_id=listing.id, product_page=1) }}" method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="grid-container">
        <!-- Product, calculations, contractors -->
        <div class="left-container">
            <div class="upper_left_container" id="info_div" style="position: relative;">
                
                <!-- Product -->
                <div class="clickable_list_element product" id="product_button" style="height: 33%;">


                    <div style="min-height: 100%;">
                        <div class="horizontal-container even" style="padding: 0% 2% 0% 2%;">
                            <div style="justify-content: center; margin-top: 2.8%;">
                                <h3 style="font-size: 2.4vh; line-height: 1.8vh; padding: 0; margin: 0">{{ listing.category.value }}</h3>
                            </div>
                            <h4 style="text-align: right; align-self: center; margin-bottom: 10%">{{listing.address}}</h4>
                        </div>
                    </div>
                    <div class="horizontal-container even">
                        <div></div>
                        <button type="button" class="zoom_button" id="zoom_button"></button>
                    </div>
                    
                    
                    <div id="info" style="display:flex; flex-direction: column; justify-content: space-between;">
                        <div class="horizontal-container even">
                            <div class="horizontal-container">
                                <h3 style="font-size: 1.6vh; margin-right: 5%">{{ _("description")}}:</h3>
                                <p style="font-size: 1.2vh; text-align: left;">{{listing.description}}</p>
                            </div>

                            <h3 style="font-size: 2.2vh;">{{listing.price}}</h3>
                            
                        </div>
                        
                        <h3>{{_("filter_contractors")}}:</h3>
                        <div class="horizontal-container" id="switch_div">
                            <label class="switch" style="height: 100%;">
                                <input type="checkbox" id="can_process">
                                <span class="slider"></span>
                            </label>
                            <label for="can_process" style="align-self: center; font-size: 1.5vh; color: rgb(0, 0, 0);">{{ _("can process") }}</label>
                        </div>
                    </div>
                </div>
                
                <!-- Emissions -->
                <div class="clickable_list_element emission" id="emissions_button" style="height: 33%; position: relative">
                    <div style="min-height: 100%; align-items: flex-start;">
                        <div class="horizontal-container even" style="align-items: flex-end;  margin-bottom: 30%; padding: 0% 2% 0% 2%;">
                            <h3 style="font-size: 2.2vh;">{{ _("emissions") }}</h3>
                            <h3 style="font-size: 2.2vh;">89 kg CO2</h3>
                        </div>
                    </div>
                    <div id="info">
                        <div class="horizontal-container even">
                            <div>
                                <div class="horizontal-container">
                                    <h3><label for="fuelType">{{ _("fuel") }}</label></h3>
                                    <select id="fuelType" name="fuelType">
                                        <option value="diesel">{{ _("diesel") }}</option>
                                        <option value="petrol">{{ _("petrol") }}</option>
                                        <option value="biodiesel">{{ _("biodiesel") }}</option>
                                        <option value="natural_gas">{{ _("natural_gas") }}</option>
                                        <option value="bio_gas">{{ _("biogas") }}</option>
                                        <option value="electricity">{{ _("electricity") }}</option>
                                    </select>
                                </div>
                                <div class="horizontal-container">
                                    <h3><label for="fuel_efficiency">{{ _("fuel_efficiency") }}</label></h3>
                                    <input type="number" name="fuel_efficiency" step="0.1" min="0" max="200" value=50>
                                    <span id="unit">l/100 km</span>
                                </div>
                            </div>
                            {% if show_route %}
                            <div>
                                <table>
                                    <tr>
                                        <th align="left">{{ _("fuel") }}</th>
                                        <th align="left">kg CO2</th>
                                        {% for emission in emission_comparison %}
                                    <tr>
                                        <td align="left">{{ _(emission) }}</td>
                                        <td align="right">{{emission_comparison[emission]}}</td>
                                        {% endfor %}
                                </table>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Route specs -->
                <div class="clickable_list_element route" id="route_info_button" style="height: 33%; position: relative">
                    <div style="min-height: 100%; align-items: flex-start;">
                        <div class="horizontal-container even" style="align-items: flex-end;  padding: 0% 2% 0% 2%;">
                            <h3 style="font-size: 2vh;">Route</h3>
                            <div class="horizontal-container">
                                <h2 style="font-size: 1.9vh;">102 km</h2>
                                <h2 style="font-size: 1.9vh;">2:26 h</h2>
                            </div>
                        </div>
                    </div>
                    <div id="info">
                        <div class="horizontal-container">
                            <h3>This route is so EPIC! Hopefully the journey never ends!</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contractors are listed here -->
            <div class="contractor_list_container card_scrollbox" id="company_div">
                <div id="blank" class="empty_list_element" style="display: none;">
                    <h1 style="text-align: center;">{{_("no contractors")}}</h1>
                </div>
            </div>
        </div>

        <!--=======================================================================================-->
        <div class="right-container">

            <!-- Search location + show all -->
            <div class="horizontal-container even toolbar">
                
                <!--Select all slider-->
                <div class="horizontal-container" style="justify-content: flex-start; margin-left: 5%;">
                    <label class="switch">
                        <input type="checkbox" id="selectAll">
                        <span class="slider"></span>
                    </label>
                    <label for="selectAll" style="align-self: center; font-size: 1.5vh; color: white;">{{ _("show_all") }}</label>
                </div>
                
                <!--Input destination-->
                <div class="horizontal-container" style="justify-content: flex-end; min-height: 100%; width: 60%; margin-right: 3%;">
                        <button id="set_goal" type="button" class="goal_button"></button>
                        <input class="toolbar stylish-input" type="text" name="address" id="address_input" placeholder="{{ _('input_address_placeholder') }}">
                        <button type="submit" class="search_button" id="search_button"></button>
                </div>
            
            </div>

            <!-- Map -->
            <div class="map_container" id="map">
                <!-- Include Leaflet JavaScript and CSS -->
                <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
                <script src="https://unpkg.com/leaflet/dist/leaflet-src.js"></script>

                <!-- Include Leaflet Routing Machine JavaScript and CSS -->
                <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
                <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

                <div class="top-buttons leaflet-left">
                    <!--Focus on companies-->
                    <h1 style="margin-right: 5px; font-size: 300%; color: var(--);" id="company_count">0</h1>
                    <button type="button" class="companies_button pressed" id="companies_button">
                    </button>
                    <button type="button" class="route_button" id="route_button">
                        <div style="margin-left: 60px">
                            <h1 style="font-size: 300%; color: var(--);" id="route_count"> </h1>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="layout-footer">
        <p>{{ _("footer_contact") }}: info@example.com</p>
        <p>{{ _("footer_last_updated") }}: {{ config.BUILD_DATE }}</p>
    </div>
    </form>
    
</body>

<script type="module">
    import { VisionController } from '/static/vision.js'
    import * as leafletIcons from '/static/leaflet_icons.js'
    import { runListElementAnimation } from '/static/element_factory.js'

    // Interactive elements
    const routeButton = document.getElementById('route_button')
    const companiesButton = document.getElementById('companies_button')
    const companyCount = document.getElementById("company_count")
    const companyDiv = document.getElementById("company_div")
    const setGoalButton = document.getElementById('set_goal')
    const searchButton = document.getElementById('search_button')
    const mapDiv = document.getElementById('map')
    const addressInput = document.getElementById('address_input')
    const selectAll = document.getElementById('selectAll');
    const handleCB = document.getElementById('can_process')
    const productButton = document.getElementById('product_button')
    const emissionsButton = document.getElementById('emissions_button')
    const routeInfoButton = document.getElementById('route_info_button')
    const upperLeft = document.getElementById('info_div')

    Array.from(upperLeft.children).forEach(element => {
        element.style.setProperty('--closed-height', '33%');
        element.style.setProperty('--open-height', '100%');
        element.querySelector('div').style.height = '33%'
        element.style.setProperty('--to-height', '33%')
    });
    
    productButton.scrollIntoView({block:'start'})
    //Create feature-type JSON. It's used in VisionController.
    const getJson = function (coordinates, name, address) {
        return {
            "geometry": {
                "coordinates": [
                    parseFloat(coordinates[1]),
                    parseFloat(coordinates[0])
                ]
            },
            "properties": {
                "name": name,
                "address": address
            }
        }
    }

    //Contractors and product locations in JSON format
    var in_range_gjson = JSON.parse('{{ in_range | tojson | safe }}');
    console.log(in_range_gjson)
    var out_range_gjson = JSON.parse('{{ out_range | tojson | safe }}');
    var product = getJson (
        ['{{ listing.location.latitude }}','{{ listing.location.longitude }}'],
        '{{ listing.category.value }}',
        '{{listing.address}}'
    )
    
    // Create map
    const map = L.map('map', { doubleClickZoom: false, setClosePopupOnClick:false })
                    .setView([62.9, 26.4], 10);
    // Create vision controller
    const V = new VisionController(L, map)

    // Add tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Add scale
    L.control.scale().addTo(map);
    
    // Add marker to product location
    V.addMapFeatureToGroup(product, 'product', leafletIcons.product, productButton)
    
    // Visual representation of the route
    if ('{{ route_geojson }}'.length !== 0) {
        // Add route on map
        var route_geojson = JSON.parse('{{ route_geojson }}'.replaceAll('&#34;', '"'));
        console.log(route_geojson)
        // Add destination to vision controller
        var destination = getJson(
            route_geojson["features"][0]["geometry"]["coordinates"].pop().reverse(),
            "Destination",
            '{{ user_location.address }}'
        )
        console.log(destination)
        V.addMapFeatureToGroup(destination, 'destination', leafletIcons.goal)
        V.addRouteToGroup(route_geojson, '{{ listing.address }}')
    }

    //================================================================ UPPER LEFT INFO
    // Open product info
    productButton.addEventListener('click', function (event) {
        if (event.target.closest('div').id == 'switch_div') {
            return;
        }
        if (event.target.id === 'zoom_button') return;
        var target = event.target.closest('.clickable_list_element')
        if (target.classList.contains('selected')) {
            runListElementAnimation(target, 1, 'info')
        } else {
            runListElementAnimation(target, 2, 'info')
        }
    })

    productButton.querySelector('#zoom_button').addEventListener('click', function() {
        V.centerFocusOn(product)
    })

    

    // Open emissions info
    emissionsButton.addEventListener('click', function(event) {
        if (event.target.tagName.toLowerCase() === 'select') {
            return;
        }
        if (event.target.tagName.toLowerCase() === 'input') {
            return;
        }
        var target = event.target.closest('.clickable_list_element')
        if (target.classList.contains('selected')) {
            runListElementAnimation(productButton, 1)
            runListElementAnimation(target, 1,'info')
            runListElementAnimation(routeInfoButton, 1)
        } else {
            runListElementAnimation(productButton, 0)
            runListElementAnimation(target, 2, 'info')
            runListElementAnimation(routeInfoButton, 0)

        }
    })
    
    // Open route info
    routeInfoButton.addEventListener('click', function() {
        if (!event.target.classList.contains('clickable_list_element')) return;
        if (this.classList.contains('selected')) {
            runListElementAnimation(productButton, 1)
            runListElementAnimation(this, 1, 'info')
            runListElementAnimation(emissionsButton, 1)
        } else {
            runListElementAnimation(productButton, 0)
            runListElementAnimation(this, 2, 'info')
            runListElementAnimation(emissionsButton, 0)
        }
    })

    //================================================================= TOOLBAR
     // Toggle 'Show all'
     selectAll.addEventListener("change", function () {
        V.toggleGroupVisibility('suboptimal')
    });

    // Toggle 'Destination selector'
    setGoalButton.addEventListener('click', function() {
        if (event.target.classList.contains('pressed')) {
            mapDiv.classList.remove('set_goal')
            setGoalButton.classList.remove('pressed')
        } else {
            mapDiv.classList.add('set_goal')
            setGoalButton.classList.add('pressed')
        }
    })

    //======================================================================== FILTER SWITCHES
    //Toggle cargo process button
    handleCB.addEventListener('change', function(e) {
        if (this.checked) {
            V.filterBy('can_process', true)
        } else {
            V.filterBy('can_process', false)
        }
    })

    //======================================================================== MAP & BUTTONS
     // Click on map
     map.on('click', function (e) {
        var clickLat = e.latlng.lat
        var clickLng = e.latlng.lng
        // If destination selection is on, post chosen coordinates
        if (setGoalButton.classList.contains('pressed')) {
            mapDiv.classList.remove('set_goal')
            setGoalButton.classList.remove('pressed')
            addressInput.value=clickLat+","+clickLng
            searchButton.click()
        }
    })

    // Toggle focus on companies
    companiesButton.addEventListener('click', function() {
        if (companiesButton.classList.contains('pressed')) {
            companiesButton.classList.remove('pressed')
        } else {
            companiesButton.classList.add('pressed')
        }
        V.toggleCompanyFocus()
    })

    // Toggle focus on route
    if (routeButton != null) {
        routeButton.addEventListener('click', function() {
            if (routeButton.classList.contains('pressed')) {
                routeButton.classList.remove('pressed')
            } else {
                routeButton.classList.add('pressed')
            }
            V.toggleGroupVisibility('{{listing.address}}')
        })
    }

    
    //Init===========================================================================================================
    document.addEventListener('DOMContentLoaded', function() {
        V.addListFeaturesToGroup(in_range_gjson.features, 'optimal', leafletIcons.okTruck, companyDiv)
        V.addListFeaturesToGroup(out_range_gjson.features, 'suboptimal', leafletIcons.badTruck, companyDiv)
        //Add empty list element in the list
        var empty = document.createElement('div')
        empty.classList.add('empty_list_element')
        companyDiv.appendChild(empty)
        // Hide suboptimals
        V.toggleGroupVisibility('suboptimal')
        // Focus on everything visible on the map
        V.addFocusOnVisibleListElements()
    });

</script>
</html> 