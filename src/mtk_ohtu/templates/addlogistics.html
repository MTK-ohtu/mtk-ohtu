{% extends "layout.html" %}

{% block content %}

<div>
    <h2>Add a logistics service</h2>
    <form id="logisticsForm" action="/addlogistics" method="post" onsubmit="return validateForm()">
        <h4>Select service type</h4>
        
        <div class="service-option">
            <input type="radio" id="private" name="serviceType" value="private" onclick="toggleQuestions()">
            <label for="private" class="circle-label">Private contractor</label>
        </div>

        <div class="service-option">
            <input type="radio" id="company" name="serviceType" value="company" onclick="toggleQuestions()">
            <label for="company" class="circle-label">Company</label>
        </div>

        <div id="privateQuestions" style="display: none;">
            <label for="fullName">Your full name:</label>
            <input type="text" id="fullName" name="fullName"><br>
        </div>

        <div id="companyQuestions" style="display: none;">
            <label for="companyName">Company name:</label>
            <input type="text" id="companyName" name="companyName"><br>
            <label for="businessId">Business ID:</label>
            <input type="text" id="businessId" name="businessId"> <br>
        </div>
        <br>
        <div id="allQuestions">
            <label for="address">Address:</label>
            <input type="text" id="address" name="address"><br>

            <h4>Approximately how far can you deliver (leave empty for no limit)</h4>
            <label for="radius"></label>
            <input type="text" id="radius" name="radius"> kilometers

            <h4>Add materials you can deliver</h4>
            <div id="materials-container">
                <div class="material-entry">
                    <div class="card">
                        <h3>New material</h3>
                        <label for="dropdown">Select material:</label>
                        <select class="material-dropdown" name="materials[]">
                            {% for material in material_categories %}
                            <option value="{{ material }}">{{ material }}</option>
                            {% endfor %}
                        </select>
                        <br>
                        <label for="base_rate">Base rate:</label>
                        <input type="text" class="base-rate" name="base_rates[]"> €<br> 
                        <label for="price_per_hour">Price per hour:</label>
                        <input type="text" class="price-per-hour" name="prices_per_hour[]"> €<br>
                        <label for="max_capacity">Maximum capacity:</label>
                        <input type="text" class="max-capacity" name="max_capacities[]"> tons<br>
                        <label for="max_distance">Maximum delivery distance:</label>
                        <input type="text" class="max-distance" name="max_distances[]"> kilometers
                    </div>
                </div>
            </div>

            <button type="button" onclick="addMaterial()">Add new</button>
        </div>
        <br>
        <input type="submit" value="Submit">
    </form>
</div>

<script>
    function deleteMaterial(entry) {
        const materialsContainer = document.getElementById('materials-container');
        materialsContainer.removeChild(entry);
    }

    function addMaterial() {
        const materialsContainer = document.getElementById('materials-container');
        const materialEntry = document.querySelector('.material-entry').cloneNode(true);

        materialEntry.querySelector('.material-dropdown').value = '';
        materialEntry.querySelector('.price-per-hour').value = '';
        materialEntry.querySelector('.base-rate').value = '';
        materialEntry.querySelector('.max-capacity').value = '';
        materialEntry.querySelector('.max-distance').value = '';

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete field';
        deleteButton.className = 'delete-material';
        deleteButton.type = 'button';
        deleteButton.onclick = function () { deleteMaterial(materialEntry); };

        materialEntry.appendChild(deleteButton);
        materialsContainer.appendChild(materialEntry);
    }

    function toggleQuestions() {
        var serviceType = document.querySelector('input[name="serviceType"]:checked').value;
        var privateQuestions = document.getElementById("privateQuestions");
        var companyQuestions = document.getElementById("companyQuestions");

        if (serviceType === "private") {
            privateQuestions.style.display = "block";
            companyQuestions.style.display = "none";
        } else if (serviceType === "company") {
            privateQuestions.style.display = "none";
            companyQuestions.style.display = "block";
        }
    }

    function validateForm() {
        var serviceType = document.querySelector('input[name="serviceType"]:checked');
        var fullName = document.getElementById("fullName");
        var companyName = document.getElementById("companyName");
        var businessId = document.getElementById("businessId");
        var address = document.getElementById("address");
        var radius = document.getElementById("radius");

        if (!serviceType) {
            alert("Please choose a service type (private or company).");
            return false;
        }

        if (serviceType.value === "private") {
            if (!fullName || fullName.value.trim() === "") {
                alert("Please enter your full name.");
                return false;
            }
        } else if (serviceType.value === "company") {
            if (!companyName || companyName.value.trim() === "") {
                alert("Please enter the company name.");
                return false;
            }

            if (!businessId || businessId.value.trim() === "") {
                alert("Please enter the business ID.");
                return false;
            }
        }

        if (!address || address.value.trim() === "") {
            alert("Please enter the address.");
            return false;
        }

        if (radius.value.trim() !== "" && isNaN(radius.value.trim())) {
            alert("Radius must be a number.");
            return false;
        }

        var materialEntries = document.querySelectorAll('.material-entry');
        for (var i = 0; i < materialEntries.length; i++) {
            var materialDropdown = materialEntries[i].querySelector('.material-dropdown');
            var pricePerHour = materialEntries[i].querySelector('.price-per-hour');
            var baseRate = materialEntries[i].querySelector('.base-rate');
            var maxCapacity = materialEntries[i].querySelector('.max-capacity');
            var maxDistance = materialEntries[i].querySelector('.max-distance');

            if (materialDropdown.value.trim() === "") {
                alert("Please select a material type in entry " + (i + 1) + "or delete the field.");
                return false;
            }

            if (pricePerHour.value.trim() === "" || isNaN(pricePerHour.value.trim())) {
                alert("Please enter a valid price per hour in entry " + (i + 1) + "or delete the field.");
                return false;
            }

            if (baseRate.value.trim() === "" || isNaN(baseRate.value.trim())) {
                alert("Please enter a valid base rate in entry " + (i + 1) + "or delete the field.");
                return false;
            }

            if (maxCapacity.value.trim() === "" || isNaN(maxCapacity.value.trim())) {
                alert("Please enter a valid maximum capacity in entry " + (i + 1) + "or delete the field.");
                return false;
            }

            if (maxDistance.value.trim() === "" || isNaN(maxDistance.value.trim())) {
                alert("Please enter a valid maximum delivery distance in entry " + (i + 1) + "or delete the field.");
                return false;
            }
        }

        return true;
    }
</script>

{% endblock %}