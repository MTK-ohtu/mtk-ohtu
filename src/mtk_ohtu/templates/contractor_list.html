{% extends "layout.html" %}

{% block content %}


<div class = "card" style="  display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
    <div style="background-color: #f1f1f1; padding: 20px; font-size: 18px;">    

        <div>
            <h2 style="align-self: center;">Suitable contractors</h2>
            <input type="checkbox" id="selectAll">
            <label for="selectAll">Select all contractors</label>
        </div>
        <div style ="overflow: auto;border: 1px solid #ccc;">
            {% for contractors in contractors %}
            <div class="card">
                <h2><a href=“#”>{{ contractors.name }}</a></h2>
                <p>{{ contractors.address}}</p>
            </div>
            {% endfor %}
        </div>
        
    </div>

    <div style="background-color: #f1f1f1; padding: 20px; font-size: 18px;">
        <div>
            <!-- Include Leaflet JavaScript and CSS -->
            <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
            <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        </div>

        <!-- Add a container for the map -->
        <div id="map" style="height: 800px;"></div>

        <!-- Setup leaflet  -->
        <script>
            console.log("Setting up")

            // Set coordinates to match viewers
            var map = L.map('map', {zoomSnap: 0.05, zoomDelta: 0.25}).setView(['{{ lat }}','{{ lon }}'], 10); 

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            var redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            var out_range_style = {
                "color": "#ff7800",
                "opacity": 0.5
            }
            //Show location of source
            var source = L.marker(['{{ lat }}','{{ lon }}'], {icon: redIcon}).addTo(map);
            source.bindPopup('<b>' + '{{ content }}' + '</b><br>' + '{{ address }}').openPopup();

            var in_range_gjson = JSON.parse('{{ in_range | tojson | safe }}');
            var out_range_gjson = JSON.parse('{{ out_range | tojson | safe }}');

            console.log(in_range_gjson)
            console.log(out_range_gjson)
            //Define popups
            function onEachFeature(feature, layer) {
                if (feature.properties && feature.properties.name && feature.properties.address) {
                    layer.bindPopup('<b>' + feature.properties.name + '</b><br>' + feature.properties.address);
                }
            }

            // Add contractor locations (database)
            in_gjson = L.geoJSON(in_range_gjson, {onEachFeature: onEachFeature});
            out_gjson = L.geoJSON(out_range_gjson, {onEachFeature: onEachFeature});

            var baseLayer = {"In Range": in_gjson}
            var overlayLayers = {"Out of Range": out_gjson}

            var layerControl = L.control.layers(baseLayer, overlayLayers).addTo(map).addTo(map);

            in_gjson.addTo(map);
            out_gjson.addTo(map);
            map.removeLayer(out_gjson);
            map.flyToBounds(in_gjson.getBounds());

            L.control.scale().addTo(map);

            const selectAll = document.getElementById('selectAll');
            selectAll.addEventListener("change", function(){
                if (this.checked) {
                    out_gjson.addTo(map)
                }
                else {
                    map.removeLayer(out_gjson);
                }
            });
        </script>
    </div>
</div>

{% endblock %}