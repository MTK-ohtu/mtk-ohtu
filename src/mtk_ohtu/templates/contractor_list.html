
<!-- This view is divided into two vertical blocks -->
<div class = "card">
    <!-- style="  display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;"-->
    <!-- Block1: list view --> ->
    <div  style="background-color: #f1f1f1; padding: 20px; font-size: 18px; height: 65vh; width: 100vh; float: left;">    

        <div>
            <h2 style="align-self: center;">Suositellut kuljetuspalvelut</h2>
            <input type="checkbox" id="selectAll">
            <label for="selectAll">Näytä kaikki</label>
        </div>

        <div id="list_div" style ="overflow: auto;border: 1px solid #ccc; overflow-y: scroll; height: 80%;">
        </div>
        
    </div>

    <!-- Block 2: map -->
    <div name="map_div" style="background-color: #f1f1f1; padding: 20px; font-size: 18px;">
        <div>
            <!-- Include Leaflet JavaScript and CSS -->
            <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
            <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        </div>

        <!-- Add a container for the map -->
        <div id="map" style="height: 800px;"></div>

        <style>
            img.huechange1 {
                filter: hue-rotate(-120deg);
            }
        
            img.huechange2 {
                filter: hue-rotate(120deg);
            }
        </style>
        <!-- Leaflet + code -->
        <script>

            var padding = 0.02;
            var hidden_elements = [];
            var in_range_gjson = JSON.parse('{{ in_range | tojson | safe }}');
            var out_range_gjson = JSON.parse('{{ out_range | tojson | safe }}');
            var address_to_marker = {};
            var listElement_to_coord = {};
            var marker_to_listElement = {};
            var last_open = null;


            // Set coordinates to match viewers'
            var map = L.map('map').setView(['{{ lat }}','{{ lon }}'], 10); 

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Add tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            var product = L.marker(['{{listing.location.latitude}}', '{{listing.location.longitude}}']).addTo(map);
            product._icon.classList.add('huechange1');
            product.bindPopup("{{listing.category.value}}\n{{listing.address}}");

            if ('{{show_route}}') {

                var route_geojson = JSON.parse('{{ route_geojson }}'.replaceAll('&#34;', '"'));
                console.log(route_geojson);

                // Adds geojson route to map
                L.geoJSON(route_geojson).addTo(map);
                var destination = route_geojson["features"][0]["geometry"]["coordinates"].pop().reverse();

                var destinationMarker = L.marker(destination).addTo(map);
                destinationMarker._icon.classList.add('huechange2');
                destinationMarker.bindPopup("Destination");

                var bbox = route_geojson["features"][0]["bbox"];
                var southWest = L.latLng(bbox[1], bbox[0]),
                    northEast = L.latLng(bbox[3], bbox[2]),
                    bounds = L.latLngBounds(southWest, northEast);

                map.fitBounds(bounds);
            }

            var redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            // Marker creation
            function create_marker (feature, latlng) {
                var myIcon = redIcon;
                var marker = L.marker(latlng, { icon: myIcon });
                console.log("Create marker for "+feature.properties.address)
                address_to_marker[feature.properties.address] = marker;
                return marker;
            }

            var out_range_style = {
                "color": "#ff7800",
                "opacity": 0.5
            }

            //Show location of the source
            var source = L.marker(['{{ lat }}','{{ lon }}'], {icon: redIcon}).addTo(map);
            source.bindPopup('<b>' + '{{ content }}' + '</b><br>' + '{{ address }}').openPopup();

            //Define popups
            function onEachFeature(feature, layer) {
                if (feature.properties && feature.properties.name && feature.properties.address) {
                    layer.bindPopup('<b>' + feature.properties.name + '</b><br>' + feature.properties.address);
                }
            }
            
            // Add contractor locations (database)
            in_gjson = L.geoJSON(in_range_gjson, {onEachFeature: onEachFeature, pointToLayer: create_marker});
            out_gjson = L.geoJSON(out_range_gjson, {onEachFeature: onEachFeature, pointToLayer: create_marker});
            in_gjson.addTo(map);


            // Initialize map view
            var combinedBounds = in_gjson.getBounds().pad(padding);
            L.control.scale().addTo(map);
            map.flyToBounds(in_gjson.getBounds().pad(0.01));

            var mapFit = function() {
                console.log("Fly to bounds")
            }

            // Show / hide suboptimal contractors (in list and map)
            const selectAll = document.getElementById('selectAll');
            var mapFit = selectAll.addEventListener("change", function(){
                if (this.checked) {
                    out_gjson.addTo(map)
                    combinedBounds = in_gjson.getBounds().pad(padding).extend(out_gjson.getBounds().pad(padding));
                    map.flyToBounds(combinedBounds);
                    hidden_elements.forEach(element => {element.style.display ='block'})
                }
                else {
                    map.removeLayer(out_gjson);
                    combinedBounds = in_gjson.getBounds().pad(padding).extend(in_gjson.getBounds().pad(padding));
                    map.flyToBounds(combinedBounds);
                    hidden_elements.forEach(element => {element.style.display ='none'})
                }
            });

            //====================================================== Create elements on the list
            function addElement(feature, hide){
                console.log("Create list element "+feature.properties.address)

                var listElement = document.createElement('button');
                listElement.id = feature.properties.address
                listElement.classList.add('clickable_list_element')
                listElement.innerHTML = '<strong>' + feature.properties.name + '</strong><br>' + feature.properties.address;

                var info = document.createElement('div');
                info.style.display = 'none';
                info.classList.add('card');
                info.innerHTML = '<div><br>Palveluinfo</br></div>'

                listElement.appendChild(info)
                document.getElementById('list_div').appendChild(listElement);

                listElement_to_coord[listElement.id] = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];

                if (hide) {
                    listElement.style.display = 'none';
                    listElement.style.backgroundColor = 'red';
                    hidden_elements.push(listElement);
                }

                listElement.addEventListener('click', function() {
                    var info = listElement.querySelector('div');
                    info.addEventListener('click', () => {event.stopPropagation();});
                    var id = event.target.id
                    map.flyTo(listElement_to_coord[id], 9);
                    address_to_marker[id].openPopup();
                    if (info.style.display === 'none') {
                        info.style.display = 'block';
                        if (last_open != null) {
                            last_open.style.display = 'none'
                        }
                        last_open = info;
                        listElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    } else {
                        info.style.display = 'none';
                        last_open = null;
                        map.flyToBounds(combinedBounds);
                    }
                });
            }
            in_range_gjson.features.forEach(feature => addElement(feature, false));
            out_range_gjson.features.forEach(feature => addElement(feature, true));
        </script>
    </div>
</div>