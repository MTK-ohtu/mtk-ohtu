<!-- This view is divided into two vertical blocks -->
<div style="height: 70vh;">

    <!-- Block 1: List for contractor cards-->
    <div style="background-color: #f1f1f1; padding: 10px; font-size: 18px;  width: 60vh; float: left;">
        <div id="list_div" style="overflow: auto;border: 1px solid #ccc; overflow-y: scroll; height: 800px;">
        </div>
    </div>

    <!-- Block 2: Map -->
    <div name="map_div" style="background-color: #f1f1f1; padding: 20px; font-size: 18px;">
        <div>
            <!-- Include Leaflet JavaScript and CSS -->
            <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
            <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        </div>

        <!-- Add a container for the map -->
        <div id="map" style="height: 800px;"></div>

        <style>
            img.huechange1 {
                filter: hue-rotate(-120deg);
            }

            img.huechange2 {
                filter: hue-rotate(120deg);
            }
        </style>

        <!-- Leaflet + code -->
        <script>

            var padding = 0.1;
            var hidden_elements = [];
            var in_range_gjson = JSON.parse('{{ in_range | tojson | safe }}');
            var out_range_gjson = JSON.parse('{{ out_range | tojson | safe }}');

            // Mappings
            var address_to_marker = {};
            var listElement_to_coord = {};
            var address_to_listElement = {};

            var last_open = null;
            const companyCount = document.getElementById("company_count")
            var defaultCoordinates = [62.41920782078211, 26.061582656316585]
            var productCoordinates = [parseFloat('{{ listing.location.latitude }}'), parseFloat('{{ listing.location.longitude }}')]

            // Icons
            var okTruck = new L.Icon({
                iconUrl: '/static/images/ok_truck.png',
                shadowUrl: '/static/images/point.png',
                iconSize: [25, 25],
                iconAnchor: [8, 25],
                popupAnchor: [1, -34],
                shadowSize: [10, 10],
                shadowAnchor: [0, 0]
            });

            var badTruck = new L.Icon({
                iconUrl: '/static/images/bad_truck.png',
                shadowUrl: '/static/images/point.png',
                iconSize: [25, 25],
                iconAnchor: [8, 25],
                popupAnchor: [1, -34],
                shadowSize: [10, 10],
                shadowAnchor: [0, 0]
            });


            // Create map
            var map = L.map('map').setView(defaultCoordinates, 10);

            // Add tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // Add marker to product location
            var product = L.marker(productCoordinates).addTo(map);
            product._icon.classList.add('huechange1');
            product.bindPopup("{{ listing.category.value }}\n{{ listing.address }}");

            // Add scale
            L.control.scale().addTo(map);

            // Read lat long from a click on the map
            map.on('click', function (e) {
                console.log(e.latlng.lat, e.latlng.lng)
            })

            // Default bounds for route
            var southWest = L.latLng(productCoordinates.map(value => value - parseFloat(.1)));
            var northEast = L.latLng(productCoordinates.map(value => value + parseFloat(.1)));
            var route_bounds = L.latLngBounds(southWest, northEast);

            // Visual representation of the route
            if ('{{show_route}}' == 1) {
                // Add route on map
                var route_geojson = JSON.parse('{{ route_geojson }}'.replaceAll('&#34;', '"'));
                L.geoJSON(route_geojson).addTo(map);
                // Add destination on map                
                var destination = route_geojson["features"][0]["geometry"]["coordinates"].pop().reverse();
                var destinationMarker = L.marker(destination).addTo(map);
                destinationMarker._icon.classList.add('huechange2');
                destinationMarker.bindPopup("Destination");
                // Calculate route bounds on map
                var bbox = route_geojson["features"][0]["bbox"];
                var southWest = L.latLng(bbox[1], bbox[0]),
                    northEast = L.latLng(bbox[3], bbox[2]),
                route_bounds = L.latLngBounds(southWest, northEast);
            }


            // List element animations
            var runListElementAnimation = function (element) {
                minimum_height = element.querySelector('div').scrollHeight
                element.style.setProperty('--minimum-height', minimum_height+'px')
                element.style.setProperty('--total-height', (element.scrollHeight+3)+'px')
                if (element.classList.contains('open')) {
                    element.classList.remove('open')
                    element.classList.add('closed')
                } else {
                    element.classList.remove('closed')
                    element.classList.add('open')
                }
            }
            // Toggle function for list elements
            var toggleListElement = function (element) {
                if (element.classList.contains('selected')) {
                    element.classList.remove('selected')
                    last_open = null;
                    runListElementAnimation(element)
                    map.flyToBounds(route_bounds);
                } else {
                    element.classList.add('selected')
                    if (last_open != null) {
                        // Hide previosly opened list element
                        last_open.classList.remove('selected')
                        runListElementAnimation(last_open)
                    }
                    last_open = element;
                    runListElementAnimation(element)
                    element.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
                    map.flyToBounds(route_bounds.extend(listElement_to_coord[element.id]));
                }
            }
                
            // Marker creation for optimal contractors
            function create_marker(feature, latlng) {
                var marker = L.marker(latlng, { icon: okTruck });
                marker.on('click', function (e) {
                    listElement = address_to_listElement[feature.properties.address]
                    toggleListElement(listElement);
                });
                address_to_marker[feature.properties.address] = marker;
                return marker;
            }
            // Marker creation for suboptimal contractors
            function create_badmarker(feature, latlng) {
                var marker = L.marker(latlng, { icon: badTruck });
                marker.on('click', function (e) {
                    listElement = address_to_listElement[feature.properties.address]
                    toggleListElement(listElement);
                });
                address_to_marker[feature.properties.address] = marker;
                return marker;
            }
            //Define popups for contractor markers
            function onEachFeature(feature, layer) {
                if (feature.properties && feature.properties.name && feature.properties.address) {
                    layer.bindPopup('<b>' + feature.properties.name + '</b><br>' + feature.properties.address);
                }
            }

            // Two sets of gjson for optimal and suboptimal. Set popups and icons.
            in_gjson = L.geoJSON(in_range_gjson, { onEachFeature: onEachFeature, pointToLayer: create_marker });
            out_gjson = L.geoJSON(out_range_gjson, { onEachFeature: onEachFeature, pointToLayer: create_badmarker });

            var combined_bounds = in_gjson.getBounds().extend(out_gjson.getBounds())
            console.log(in_gjson.getBounds())
            console.log(combined_bounds)

            // Checkbox 'Show all' functionality
            const selectAll = document.getElementById('selectAll');
            selectAll.addEventListener("change", function () {
                if (this.checked) {
                    out_gjson.addTo(map);
                    hidden_elements.forEach(element => { element.style.display = 'block' })
                    companyCount.textContent = in_range_gjson.features.length + out_range_gjson.features.length
                    map.flyToBounds(combined_bounds.extend(route_bounds));
                }
                else {
                    map.removeLayer(out_gjson);
                    hidden_elements.forEach(element => { element.style.display = 'none' });
                    companyCount.textContent = in_range_gjson.features.length;
                    map.flyToBounds(in_gjson.getBounds().extend(route_bounds));
                }
            });

            // Create elements to show on the list side ====================================================================
            function addElement(feature, hide) {
                // Create new button as list element
                var listElement = document.createElement('button');
                listElement.id = feature.properties.address
                // Create inner HTML for the button
                listElement.innerHTML = `
                    <div class="horizontal-container even">
                        <h4 style="align-self: left;">${feature.properties.name}</h4>
                        <p style="align-self: center;">${feature.properties.address}</p>
                    </div>
                    <p id="info">TEKSTI</p>
                    `;
                // Add element to list
                listElement.classList.add('clickable_list_element');
                // This will be added 
                listElement.classList.add('open')
                listElement.style.borderRadius = '20px 0 0 0'
                document.getElementById('list_div').appendChild(listElement);
                runListElementAnimation(listElement)

                // Add element to mappings
                listElement_to_coord[listElement.id] = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
                address_to_listElement[feature.properties.address] = listElement;
                // Define style of list element if it's set out to be 'hidden'
                if (hide) {
                    listElement.style.display = 'none';
                    listElement.classList.add('suboptimal')
                    hidden_elements.push(listElement);
                }
                // Functionality for clicking this list element
                listElement.addEventListener('click', function () {
                    // Make sure that target (button) is the list element it self
                    if (event.target.tagName === 'BUTTON') {
                        var button = event.target;
                    } else {
                        var button = event.target.closest('button');
                    }
                    // Toggle popup in corresponding marker
                    marker = address_to_marker[button.id];
                    if (marker.isPopupOpen()) {
                        marker.closePopup()
                    } else {
                        marker.openPopup()
                    }
                    // Toggle info in the list element
                    toggleListElement(button)
                });
            } // ==============================================================================================

            // Add list elements on the list side
            in_range_gjson.features.forEach(feature => addElement(feature, false));
            if (out_range_gjson.length != 0) {
                out_range_gjson.features.forEach(feature => addElement(feature, true));
            }   
            // By default, show only optimal contractors on the map
            in_gjson.addTo(map);

            // Default setup 
            companyCount.textContent = in_range_gjson.features.length
            map.flyToBounds(route_bounds, in_gjson.getBounds());

        </script>
    </div>
</div>